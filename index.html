<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ChemLab</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #game-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        #start-menu, #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
            transition: opacity 0.5s;
        }
        #start-menu.hidden, #game-over.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #start-menu h1, #game-over h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }
        #start-menu p, #game-over p {
            font-size: 1.2em;
            max-width: 80%;
            text-align: center;
        }
        #start-menu button, #game-over button {
            padding: 15px 30px;
            font-size: 1.2em;
            margin: 10px;
            border: none;
            border-radius: 25px;
            background: #ecf0f1;
            color: #1a2a6c;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            z-index: 5;
        }
        #joystick {
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            position: relative;
        }
        #joystick-knob {
            width: 40px;
            height: 40px;
            background: #e74c3c;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .action-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            margin: 5px;
            border: none;
            border-radius: 10px;
            background: #3498db;
            color: white;
            cursor: pointer;
        }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 5;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="start-menu">
            <h1>ChemLab</h1>
            <p>You're trapped in a secret lab after a failed experiment. Synthesize nitroglycerin to breach the door, then set the lab ablaze to escape!</p>
            <button onclick="startGame()">Start</button>
        </div>
        <div id="game-over" class="hidden">
            <h1>Game Over</h1>
            <p id="game-over-text"></p>
            <button onclick="restartGame()">Restart</button>
        </div>
        <div id="hud">Inventory: Empty</div>
        <div id="controls">
            <div id="joystick">
                <div id="joystick-knob"></div>
            </div>
            <div class="action-buttons">
                <button id="turn-left">Left</button>
                <button id="interact">Interact</button>
                <button id="turn-right">Right</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script>
        let scene, camera, renderer, player, feet, chemicals = [], door, reactionStation, flammableCabinet;
        let moveX = 0, moveZ = 0, inventory = [], fireParticles, fireSpread = 0;
        let gameStarted = false, gameEnded = false;

        // Initialize Three.js scene
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('game-container').appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x606060, 1);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 1, 50);
            pointLight.position.set(0, 5, 0);
            scene.add(pointLight);

            // Floor
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshPhongMaterial({ color: 0x7f8c8d, shininess: 10 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Walls
            const wallMaterial = new THREE.MeshPhongMaterial({ color: 0x34495e });
            const wallGeometry = new THREE.BoxGeometry(20, 5, 0.2);
            const walls = [
                new THREE.Mesh(wallGeometry, wallMaterial), // North
                new THREE.Mesh(wallGeometry, wallMaterial), // South
                new THREE.Mesh(new THREE.BoxGeometry(0.2, 5, 20), wallMaterial), // East
                new THREE.Mesh(new THREE.BoxGeometry(0.2, 5, 20), wallMaterial)  // West
            ];
            walls[0].position.set(0, 2.5, -10);
            walls[1].position.set(0, 2.5, 10);
            walls[2].position.set(10, 2.5, 0);
            walls[3].position.set(-10, 2.5, 0);
            walls.forEach(wall => scene.add(wall));

            // Player
            player = { position: new THREE.Vector3(0, 1, 0), rotation: 0, pitch: 0 };
            camera.position.copy(player.position);

            // Feet (visible when looking down)
            const feetGeometry = new THREE.BoxGeometry(0.3, 0.1, 0.5);
            const feetMaterial = new THREE.MeshBasicMaterial({ color: 0x2c3e50 });
            feet = new THREE.Mesh(feetGeometry, feetMaterial);
            feet.position.set(0, -0.9, -0.2);
            camera.add(feet);
            scene.add(camera);

            // Chemicals
            const chemicalColors = { 'C3H5(OH)3': 0xe74c3c, 'HNO3': 0xf1c40f };
            const chemicalPositions = [
                { type: 'C3H5(OH)3', x: -5, z: -5 }, // Glycerin
                { type: 'HNO3', x: 5, z: -5 }         // Nitric Acid
            ];
            chemicalPositions.forEach(chem => {
                const geometry = new THREE.CylinderGeometry(0.3, 0.3, 1, 32);
                const material = new THREE.MeshPhongMaterial({ color: chemicalColors[chem.type] });
                const bottle = new THREE.Mesh(geometry, material);
                bottle.position.set(chem.x, 0.5, chem.z);
                bottle.userData = { type: chem.type };
                scene.add(bottle);
                chemicals.push(bottle);
            });

            // Reaction Station
            const stationGeometry = new THREE.BoxGeometry(2, 1, 2);
            const stationMaterial = new THREE.MeshPhongMaterial({ color: 0x95a5a6 });
            reactionStation = new THREE.Mesh(stationGeometry, stationMaterial);
            reactionStation.position.set(0, 0.5, -8);
            reactionStation.userData = { type: 'station' };
            scene.add(reactionStation);

            // Flammable Cabinet
            const cabinetGeometry = new THREE.BoxGeometry(1, 2, 1);
            const cabinetMaterial = new THREE.MeshPhongMaterial({ color: 0x8e44ad });
            flammableCabinet = new THREE.Mesh(cabinetGeometry, cabinetMaterial);
            flammableCabinet.position.set(-5, 1, 8);
            flammableCabinet.userData = { type: 'cabinet', burning: false };
            scene.add(flammableCabinet);

            // Door
            const doorGeometry = new THREE.BoxGeometry(2, 4, 0.2);
            const doorMaterial = new THREE.MeshPhongMaterial({ color: 0x2c3e50 });
            door = new THREE.Mesh(doorGeometry, doorMaterial);
            door.position.set(9, 2, 0);
            door.userData = { locked: true };
            scene.add(door);
        }

        // Start game
        function startGame() {
            document.getElementById('start-menu').classList.add('hidden');
            gameStarted = true;
            animate();
        }

        // Restart game
        function restartGame() {
            location.reload();
        }

        // Joystick controls
        const joystick = document.getElementById('joystick');
        const knob = document.getElementById('joystick-knob');
        let joystickActive = false;
        joystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            joystickActive = true;
            moveJoystick(e.touches[0]);
        });
        joystick.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (joystickActive) moveJoystick(e.touches[0]);
        });
        joystick.addEventListener('touchend', () => {
            joystickActive = false;
            moveX = 0;
            moveZ = 0;
            knob.style.left = '50%';
            knob.style.top = '50%';
        });

        function moveJoystick(touch) {
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const maxDistance = rect.width / 2 - 20;
            if (distance > maxDistance) {
                dx *= maxDistance / distance;
                dy *= maxDistance / distance;
            }
            knob.style.left = `${50 + (dx / rect.width) * 100}%`;
            knob.style.top = `${50 + (dy / rect.height) * 100}%`;
            moveX = dx / maxDistance;
            moveZ = dy / maxDistance;
        }

        // Action buttons
        document.getElementById('turn-left').onclick = () => player.rotation += 0.1;
        document.getElementById('turn-right').onclick = () => player.rotation -= 0.1;
        document.getElementById('interact').onclick = interact;

        // Interaction
        function interact() {
            if (gameEnded) return;
            const forward = new THREE.Vector3(0, 0, -1).applyEuler(camera.rotation);
            const raycaster = new THREE.Raycaster(camera.position, forward);
            const intersects = raycaster.intersectObjects([...chemicals, reactionStation, door, flammableCabinet]);
            if (intersects.length > 0) {
                const obj = intersects[0].object;
                if (obj.userData.type === 'station') {
                    performReaction();
                } else if (obj.userData.type && chemicals.includes(obj)) {
                    inventory.push(obj.userData.type);
                    scene.remove(obj);
                    chemicals = chemicals.filter(c => c !== obj);
                    animateCollect(obj);
                } else if (obj === door && inventory.includes('nitroglycerin')) {
                    obj.userData.locked = false;
                    obj.material.color.set(0x27ae60);
                    alert('Door breached with nitroglycerin!');
                } else if (obj.userData.type === 'cabinet' && !obj.userData.burning) {
                    if (!door.userData.locked) {
                        obj.userData.burning = true;
                        startFire(obj.position);
                        alert('Cabinet set ablaze! Escape now!');
                    } else {
                        alert('Breach the door first!');
                    }
                } else if (obj === door && !obj.userData.locked && flammableCabinet.userData.burning) {
                    endGame(true);
                }
            }
            updateHUD();
        }

        // Reaction logic
        function performReaction() {
            if (inventory.includes('C3H5(OH)3') && inventory.includes('HNO3')) {
                inventory = inventory.filter(item => !['C3H5(OH)3', 'HNO3'].includes(item));
                inventory.push('nitroglycerin');
                animateReaction(reactionStation.position);
                alert('Synthesized nitroglycerin!');
            } else {
                alert('Need glycerin (C3H5(OH)3) and nitric acid (HNO3)!');
            }
        }

        // Animation for collecting chemicals
        function animateCollect(obj) {
            let t = 0;
            const startPos = obj.position.clone();
            function spin() {
                t += 0.1;
                if (t < 1) {
                    obj.position.lerpVectors(startPos, camera.position, t);
                    obj.rotation.y += 0.2;
                    requestAnimationFrame(spin);
                }
            }
            spin();
        }

        // Fire animation
        function startFire(pos) {
            const particleGeometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 200; i++) {
                vertices.push((Math.random() - 0.5) * 2, Math.random() * 2, (Math.random() - 0.5) * 2);
            }
            particleGeometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const particleMaterial = new THREE.PointsMaterial({ color: 0xe74c3c, size: 0.1 });
            fireParticles = new THREE.Points(particleGeometry, particleMaterial);
            fireParticles.position.copy(pos);
            scene.add(fireParticles);
        }

        // Update fire spread
        function updateFire() {
            if (fireParticles) {
                fireSpread += 0.01;
                fireParticles.position.y += 0.05;
                fireParticles.scale.setScalar(1 + fireSpread);
                if (fireSpread > 2) {
                    const distanceToFire = player.position.distanceTo(fireParticles.position);
                    if (distanceToFire < 5) endGame(false);
                }
            }
        }

        // Update HUD
        function updateHUD() {
            document.getElementById('hud').textContent = `Inventory: ${inventory.length ? inventory.join(', ') : 'Empty'}`;
        }

        // End game
        function endGame(success) {
            gameEnded = true;
            document.getElementById('game-over').classList.remove('hidden');
            document.getElementById('game-over-text').textContent = success
                ? 'You escaped the burning lab!'
                : 'The fire consumed you!';
        }

        // Animation loop
        function animate() {
            if (!gameStarted || gameEnded) return;
            requestAnimationFrame(animate);

            // Movement
            const speed = 0.1;
            const forward = new THREE.Vector3(0, 0, -1).applyEuler(new THREE.Euler(0, player.rotation, 0));
            const right = new THREE.Vector3(1, 0, 0).applyEuler(new THREE.Euler(0, player.rotation, 0));
            player.position.add(forward.multiplyScalar(moveZ * speed));
            player.position.add(right.multiplyScalar(moveX * speed));
            player.position.clamp(new THREE.Vector3(-9.5, 1, -9.5), new THREE.Vector3(9.5, 1, 9.5));

            // Walking animation for feet
            if (moveX || moveZ) {
                feet.position.z = -0.2 + Math.sin(Date.now() * 0.01) * 0.05;
            }

            // Update camera
            camera.position.copy(player.position);
            camera.rotation.y = player.rotation;

            // Fire spread
            updateFire();

            renderer.render(scene, camera);
        }

        // Initialize
        init();
    </script>
</body>
</html>
