<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ChemEscape 3D</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #game-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        #start-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
            transition: opacity 0.5s;
        }
        #start-menu.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #start-menu h1 {
            font-size: 3em;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }
        #start-menu button {
            padding: 15px 30px;
            font-size: 1.2em;
            margin: 10px;
            border: none;
            border-radius: 25px;
            background: #ecf0f1;
            color: #2c3e50;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            z-index: 5;
        }
        #joystick {
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            position: relative;
        }
        #joystick-knob {
            width: 40px;
            height: 40px;
            background: #3498db;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .action-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            margin: 5px;
            border: none;
            border-radius: 10px;
            background: #e74c3c;
            color: white;
            cursor: pointer;
        }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 5;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="start-menu">
            <h1>ChemEscape 3D</h1>
            <button onclick="startGame()">Start</button>
            <button onclick="showInstructions()">Instructions</button>
        </div>
        <div id="hud">Inventory: Empty</div>
        <div id="controls">
            <div id="joystick">
                <div id="joystick-knob"></div>
            </div>
            <div class="action-buttons">
                <button id="turn-left">Left</button>
                <button id="interact">Interact</button>
                <button id="turn-right">Right</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script>
        let scene, camera, renderer, player, chemicals = [], doors = [], reactionStation;
        let moveX = 0, moveZ = 0, inventory = [];
        let gameStarted = false;

        // Initialize Three.js scene
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('game-container').appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 1, 100);
            pointLight.position.set(0, 10, 0);
            scene.add(pointLight);

            // Floor
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshBasicMaterial({ color: 0x95a5a6, side: THREE.DoubleSide });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = Math.PI / 2;
            scene.add(floor);

            // Walls
            const wallMaterial = new THREE.MeshBasicMaterial({ color: 0x34495e });
            const wallGeometry = new THREE.BoxGeometry(20, 5, 0.2);
            const walls = [
                new THREE.Mesh(wallGeometry, wallMaterial), // North
                new THREE.Mesh(wallGeometry, wallMaterial), // South
                new THREE.Mesh(new THREE.BoxGeometry(0.2, 5, 20), wallMaterial), // East
                new THREE.Mesh(new THREE.BoxGeometry(0.2, 5, 20), wallMaterial)  // West
            ];
            walls[0].position.set(0, 2.5, -10);
            walls[1].position.set(0, 2.5, 10);
            walls[2].position.set(10, 2.5, 0);
            walls[3].position.set(-10, 2.5, 0);
            walls.forEach(wall => scene.add(wall));

            // Player
            player = { position: new THREE.Vector3(0, 1, 0), rotation: 0 };
            camera.position.copy(player.position);
            camera.position.y += 1; // Eye level

            // Chemicals
            const chemicalColors = { H2: 0x3498db, O2: 0x95a5a6, Na: 0xecf0f1, Cl2: 0x2ecc71, N2: 0x9b59b6 };
            const chemicalPositions = [
                { type: 'H2', x: -5, z: -5 }, { type: 'O2', x: -3, z: -5 },
                { type: 'Na', x: 5, z: -5 }, { type: 'Cl2', x: 3, z: -5 },
                { type: 'N2', x: 0, z: 5 }
            ];
            chemicalPositions.forEach(chem => {
                const geometry = new THREE.CylinderGeometry(0.3, 0.3, 1, 32);
                const material = new THREE.MeshBasicMaterial({ color: chemicalColors[chem.type] });
                const bottle = new THREE.Mesh(geometry, material);
                bottle.position.set(chem.x, 0.5, chem.z);
                bottle.userData = { type: chem.type };
                scene.add(bottle);
                chemicals.push(bottle);
            });

            // Reaction Station
            const stationGeometry = new THREE.BoxGeometry(2, 1, 2);
            const stationMaterial = new THREE.MeshBasicMaterial({ color: 0xe67e22 });
            reactionStation = new THREE.Mesh(stationGeometry, stationMaterial);
            reactionStation.position.set(0, 0.5, -8);
            reactionStation.userData = { type: 'station' };
            scene.add(reactionStation);

            // Door
            const doorGeometry = new THREE.BoxGeometry(2, 4, 0.2);
            const doorMaterial = new THREE.MeshBasicMaterial({ color: 0xe74c3c });
            const door = new THREE.Mesh(doorGeometry, doorMaterial);
            door.position.set(9, 2, 0);
            door.userData = { locked: true };
            scene.add(door);
            doors.push(door);
        }

        // Start game
        function startGame() {
            document.getElementById('start-menu').classList.add('hidden');
            gameStarted = true;
            animate();
        }

        // Show instructions
        function showInstructions() {
            alert('Navigate the lab to collect chemicals.\nCombine them at the reaction station:\n- H2 + O2 = H2O\n- Na + Cl2 = HCl\n- N2 + 3H2 = NH3\nUse all three to create the escape compound and unlock the door!');
        }

        // Joystick controls
        const joystick = document.getElementById('joystick');
        const knob = document.getElementById('joystick-knob');
        let joystickActive = false;
        joystick.addEventListener('touchstart', (e) => {
            joystickActive = true;
            moveJoystick(e.touches[0]);
        });
        joystick.addEventListener('touchmove', (e) => {
            if (joystickActive) moveJoystick(e.touches[0]);
        });
        joystick.addEventListener('touchend', () => {
            joystickActive = false;
            moveX = 0;
            moveZ = 0;
            knob.style.left = '50%';
            knob.style.top = '50%';
        });

        function moveJoystick(touch) {
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const maxDistance = rect.width / 2 - 20; // Knob radius
            if (distance > maxDistance) {
                dx *= maxDistance / distance;
                dy *= maxDistance / distance;
            }
            knob.style.left = `${50 + (dx / rect.width) * 100}%`;
            knob.style.top = `${50 + (dy / rect.height) * 100}%`;
            moveX = dx / maxDistance;
            moveZ = dy / maxDistance;
        }

        // Action buttons
        document.getElementById('turn-left').onclick = () => player.rotation += 0.1;
        document.getElementById('turn-right').onclick = () => player.rotation -= 0.1;
        document.getElementById('interact').onclick = interact;

        // Interaction
        function interact() {
            const forward = new THREE.Vector3(0, 0, -1).applyEuler(camera.rotation);
            const raycaster = new THREE.Raycaster(camera.position, forward);
            const intersects = raycaster.intersectObjects([...chemicals, reactionStation, ...doors]);
            if (intersects.length > 0) {
                const obj = intersects[0].object;
                if (obj.userData.type === 'station') {
                    performReaction();
                } else if (obj.userData.type && chemicals.includes(obj)) {
                    inventory.push(obj.userData.type);
                    scene.remove(obj);
                    chemicals = chemicals.filter(c => c !== obj);
                    animateCollect(obj);
                } else if (obj.userData.locked && inventory.includes('escapeCompound')) {
                    obj.userData.locked = false;
                    obj.material.color.set(0x2ecc71);
                    alert('Door unlocked! You escaped!');
                    setTimeout(() => location.reload(), 2000);
                }
            }
            updateHUD();
        }

        // Reaction logic
        function performReaction() {
            const reactions = [
                { inputs: ['H2', 'O2'], output: 'H2O' },
                { inputs: ['Na', 'Cl2'], output: 'HCl' },
                { inputs: ['N2', 'H2', 'H2', 'H2'], output: 'NH3' },
                { inputs: ['H2O', 'HCl', 'NH3'], output: 'escapeCompound' }
            ];
            for (let reaction of reactions) {
                if (reaction.inputs.every(input => inventory.includes(input))) {
                    reaction.inputs.forEach(input => inventory.splice(inventory.indexOf(input), 1));
                    inventory.push(reaction.output);
                    animateReaction(reactionStation.position);
                    alert(`Created ${reaction.output}!`);
                    return;
                }
            }
            alert('Invalid combination!');
        }

        // Animation for collecting chemicals
        function animateCollect(obj) {
            let t = 0;
            const startPos = obj.position.clone();
            function spin() {
                t += 0.1;
                if (t < 1) {
                    obj.position.lerpVectors(startPos, camera.position, t);
                    obj.rotation.y += 0.2;
                    requestAnimationFrame(spin);
                }
            }
            spin();
        }

        // Particle animation for reactions
        function animateReaction(pos) {
            const particleGeometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 100; i++) {
                vertices.push(Math.random() - 0.5, Math.random() - 0.5, Math.random() - 0.5);
            }
            particleGeometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const particleMaterial = new THREE.PointsMaterial({ color: 0x00ff00, size: 0.1 });
            const particles = new THREE.Points(particleGeometry, particleMaterial);
            particles.position.copy(pos);
            scene.add(particles);
            let t = 0;
            function animateParticles() {
                t += 0.05;
                particles.position.y += 0.05;
                if (t < 1) requestAnimationFrame(animateParticles);
                else scene.remove(particles);
            }
            animateParticles();
        }

        // Update HUD
        function updateHUD() {
            document.getElementById('hud').textContent = `Inventory: ${inventory.length ? inventory.join(', ') : 'Empty'}`;
        }

        // Animation loop
        function animate() {
            if (!gameStarted) return;
            requestAnimationFrame(animate);

            // Movement
            const speed = 0.1;
            const forward = new THREE.Vector3(0, 0, -1).applyEuler(new THREE.Euler(0, player.rotation, 0));
            const right = new THREE.Vector3(1, 0, 0).applyEuler(new THREE.Euler(0, player.rotation, 0));
            player.position.add(forward.multiplyScalar(moveZ * speed));
            player.position.add(right.multiplyScalar(moveX * speed));
            player.position.clamp(new THREE.Vector3(-9.5, 1, -9.5), new THREE.Vector3(9.5, 1, 9.5));

            // Update camera
            camera.position.copy(player.position);
            camera.rotation.y = player.rotation;

            renderer.render(scene, camera);
        }

        // Initialize
        init();
    </script>
</body>
</html>
